# ==============================================
# File:        scripts/deployment/nginx_rate_limiting.conf
# Author:      USDTG GROUP TECHNOLOGY LLC
# Developer:   Irfan Gedik
# Created Date: 2025-12-22
# Last Update:  2025-12-22
# Version:     1.0.0
#
# Description:
#   Nginx Rate Limiting Configuration
#
#   Quantum-level DDoS protection via Nginx rate limiting.
#   Prevents both incoming and outgoing DDoS attacks.
#
# License:
#   MIT License
# ==============================================

# Rate limiting zones - IP-based
# Increased limits to prevent false positives while maintaining DDoS protection
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=300r/m;  # 300 requests per minute per IP (was 100)
limit_req_zone $binary_remote_addr zone=api_burst:10m rate=600r/m;  # Burst limit (was 200)
limit_req_zone $binary_remote_addr zone=strict_limit:10m rate=30r/m; # Strict limit for sensitive endpoints (was 10)
limit_req_zone $binary_remote_addr zone=health_limit:10m rate=1000r/m; # Health/metrics - very high limit

# Connection limiting - prevent connection exhaustion
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Rate limiting for specific endpoints
server {
    # ... existing server config ...
    
    # API endpoints - standard rate limiting
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;
        limit_conn conn_limit 10;
        
        # Timeouts to prevent slowloris attacks
        client_body_timeout 10s;
        client_header_timeout 10s;
        send_timeout 10s;
        
        # ... proxy_pass to backend ...
    }
    
    # Sensitive endpoints - strict rate limiting
    location ~ ^/api/(transfer|stake|swap|bridge) {
        limit_req zone=strict_limit burst=5 nodelay;
        limit_req_status 429;
        limit_conn conn_limit 5;
        
        # Additional security headers
        add_header X-RateLimit-Limit "10" always;
        add_header X-RateLimit-Remaining "$limit_req_status" always;
        
        # ... proxy_pass to backend ...
    }
    
    # Health and Metrics endpoints - NO strict limiting (monitoring needs access)
    location ~ ^/api/(health|metrics)$ {
        limit_req zone=health_limit burst=50 nodelay;
        limit_req_status 429;
        limit_conn conn_limit 20;
        
        # ... proxy_pass to backend ...
    }
    
    # Global connection limit per server
    limit_conn perserver 1000;
    
    # Return 429 for rate limit exceeded
    error_page 429 @ratelimit;
    location @ratelimit {
        default_type application/json;
        return 429 '{"success":false,"error":"Rate limit exceeded. Please try again later.","code":"RATE_LIMIT_EXCEEDED"}';
    }
}

# Outbound connection limiting - prevent DDoS from our servers
# This should be added to system-level iptables/ufw rules
# See firewall_ddos_protection.sh
